<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rogar's Impostor Cards - Final Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background: #0f172a; color: #ffffff; min-height: 100vh; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-gradient { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); transition: all 0.2s ease; }
        .btn-gradient-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); transition: all 0.2s ease; }
        
        .perspective-1000 { perspective: 1000px; }
        .card-inner { transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; cursor: pointer; }
        .is-flipped { transform: rotateY(180deg); }
        .backface-hidden { backface-visibility: hidden; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 24px; border: 1px solid rgba(255,255,255,0.1); }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #10b981; border-color: #10b981; }
        input:checked + .slider:before { transform: translateX(20px); }

        .progress-bar { transition: width 1s linear; }
        @keyframes pulse-red { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 20px 0 rgba(239, 68, 68, 0.2); } }
        .animate-pulse-red { animation: pulse-red 2s infinite; }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
        @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body class="p-4 flex flex-col items-center">

    <!-- HUB PRINCIPAL -->
    <div id="view-hub" class="w-full max-w-md py-12 flex flex-col items-center space-y-8">
        <header class="text-center">
            <h1 class="text-5xl font-black italic tracking-tighter leading-none mb-2">ROGAR'S<br><span class="text-indigo-500">IMPOSTOR</span></h1>
            <p class="text-[10px] uppercase tracking-[0.2em] text-gray-500 font-bold">The Final Social Game</p>
        </header>

        <div class="flex bg-white/5 p-1 rounded-2xl w-full border border-white/10">
            <button id="btn-mode-online" onclick="switchMode('online')" class="flex-1 py-3 rounded-xl font-bold text-xs transition-all bg-indigo-600 text-white shadow-lg">MODE EN LIGNE</button>
            <button id="btn-mode-local" onclick="switchMode('local')" class="flex-1 py-3 rounded-xl font-bold text-xs transition-all text-gray-400 hover:text-white">MODE LOCAL</button>
        </div>

        <div class="w-full">
            <div class="glass p-8 rounded-3xl space-y-6 shadow-2xl border-white/5">
                <div id="section-online" class="space-y-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest ml-1">Ton identit√©</label>
                        <input type="text" id="player-name" placeholder="Pseudo" class="w-full bg-white/5 p-4 rounded-2xl outline-none border border-white/10 text-center font-bold focus:border-indigo-500/50 transition-all text-white">
                    </div>
                    <div class="pt-2 space-y-3">
                        <button onclick="window.createRoom()" class="w-full btn-gradient p-5 rounded-2xl font-black shadow-lg uppercase tracking-tighter text-lg">Cr√©er un salon</button>
                        <div class="relative flex items-center py-2">
                            <div class="flex-grow border-t border-white/5"></div>
                            <span class="flex-shrink mx-4 text-[10px] font-black text-gray-600 uppercase">Ou rejoindre</span>
                            <div class="flex-grow border-t border-white/5"></div>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="room-code-input" placeholder="CODE" class="w-full bg-white/5 p-4 rounded-xl outline-none border border-white/10 text-center uppercase font-mono font-bold text-white">
                            <button onclick="window.joinRoom()" class="glass px-6 rounded-xl font-bold text-sm hover:bg-white/10 transition-colors">OK</button>
                        </div>
                    </div>
                </div>
                <div id="section-local" class="hidden text-center py-10 text-gray-500 italic">
                    Utilisez le mode Online pour profiter des nouvelles fonctionnalit√©s de gestion d'h√¥te.
                </div>
            </div>
        </div>
    </div>

    <!-- CONTAINER DE JEU DYNAMIQUE -->
    <div id="game-container" class="w-full max-w-md hidden">
        <div id="dynamic-content"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBrn4qChbtsZzP7nMKA5GGR7K024pFxtf0",
            authDomain: "rogarsimpostorcards.firebaseapp.com",
            projectId: "rogarsimpostorcards",
            appId: "1:750585646128:web:168c0926d3a6c90563f1f5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserId = null;
        let currentRoomId = null;
        let isHost = false;
        let timerInterval = null;
        let unsubscribeRoom = null;

        const wordPairs = [
            { words: ["Lion", "Tigre"], hint: "C'est un grand f√©lin sauvage." },
            { words: ["Pizza", "Burger"], hint: "C'est un plat de fast-food." },
            { words: ["Avion", "Fus√©e"], hint: "C'est un engin de vol." },
            { words: ["Soleil", "√âtoile"], hint: "C'est un astre lumineux." },
            { words: ["Stylo", "Crayon"], hint: "C'est un outil pour √©crire." }
        ];

        signInAnonymously(auth);
        onAuthStateChanged(auth, u => { if(u) currentUserId = u.uid; });

        window.switchMode = (m) => {
            document.getElementById('section-online').classList.toggle('hidden', m !== 'online');
            document.getElementById('section-local').classList.toggle('hidden', m !== 'local');
        };

        // --- GESTION DES SALONS ---

        window.createRoom = async () => {
            const name = document.getElementById('player-name').value || "Inconnu";
            const roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
            currentRoomId = roomId;
            isHost = true;
            await setDoc(doc(db, "rooms", roomId), {
                id: roomId,
                hostId: currentUserId,
                status: 'lobby',
                players: [{ id: currentUserId, name, isHost: true, role: '', word: '', eliminated: false }],
                settings: { impostorsCount: 1, hintsEnabled: true },
                gameState: { phase: 'idle', words: [], currentSpeakerIndex: 0, timer: 0, votes: {} }
            });
            listenToRoom(roomId);
        };

        window.joinRoom = async () => {
            const name = document.getElementById('player-name').value || "Inconnu";
            const roomId = document.getElementById('room-code-input').value.toUpperCase();
            if(!roomId) return;
            const snap = await getDoc(doc(db, "rooms", roomId));
            if(snap.exists() && snap.data().status === 'lobby') {
                currentRoomId = roomId;
                await updateDoc(doc(db, "rooms", roomId), {
                    players: arrayUnion({ id: currentUserId, name, isHost: false, role: '', word: '', eliminated: false })
                });
                listenToRoom(roomId);
            } else {
                alert("Salon introuvable ou d√©j√† en cours.");
            }
        };

        function listenToRoom(roomId) {
            document.getElementById('view-hub').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            
            if(unsubscribeRoom) unsubscribeRoom();
            unsubscribeRoom = onSnapshot(doc(db, "rooms", roomId), (snap) => {
                if(!snap.exists()) return window.resetToMenu();
                const data = snap.data();
                const me = data.players.find(p => p.id === currentUserId);
                if(!me) return window.resetToMenu();

                isHost = data.hostId === currentUserId;
                if(data.status === 'lobby') renderLobby(data);
                else if(data.status === 'finished') renderVictory(data);
                else renderGame(data);
            });
        }

        window.updateSettings = async (key, val) => {
            if(!isHost) return;
            const roomRef = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(roomRef);
            const settings = snap.data().settings;
            settings[key] = val;
            await updateDoc(roomRef, { settings });
        };

        window.kickPlayer = async (playerId) => {
            if(!isHost) return;
            const roomRef = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(roomRef);
            const players = snap.data().players.filter(p => p.id !== playerId);
            await updateDoc(roomRef, { players });
        };

        // --- LOGIQUE DE JEU ---

        window.startGame = async () => {
            const snap = await getDoc(doc(db, "rooms", currentRoomId));
            const data = snap.data();
            const pair = wordPairs[Math.floor(Math.random() * wordPairs.length)];
            const players = [...data.players];
            
            const impoIndices = [];
            while(impoIndices.length < data.settings.impostorsCount) {
                const r = Math.floor(Math.random() * players.length);
                if(!impoIndices.includes(r)) impoIndices.push(r);
            }

            players.forEach((p, i) => {
                p.role = impoIndices.includes(i) ? 'Imposteur' : 'Civil';
                p.word = p.role === 'Civil' ? pair.words[0] : (data.settings.hintsEnabled ? pair.hint : '???');
                p.eliminated = false;
            });

            await updateDoc(doc(db, "rooms", currentRoomId), {
                status: 'playing',
                players: players,
                gameState: {
                    phase: 'word_entry',
                    currentSpeakerIndex: 0,
                    timer: Date.now() + 16000,
                    words: [],
                    votes: {}
                }
            });
        };

        function renderLobby(data) {
            const settings = data.settings;
            document.getElementById('dynamic-content').innerHTML = `
                <div class="space-y-6 text-center animate-in fade-in">
                    <div>
                        <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Code du salon</p>
                        <h2 class="text-4xl font-black text-indigo-500 font-mono tracking-tighter">${data.id}</h2>
                    </div>

                    <div class="glass p-6 rounded-3xl space-y-4 border-white/10 text-left">
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold uppercase text-gray-400">Imposteurs</span>
                            <div class="flex items-center gap-3">
                                ${isHost ? `
                                    <button onclick="window.updateSettings('impostorsCount', Math.max(1, ${settings.impostorsCount}-1))" class="w-8 h-8 glass rounded-lg">-</button>
                                    <span class="font-black text-indigo-400">${settings.impostorsCount}</span>
                                    <button onclick="window.updateSettings('impostorsCount', Math.min(3, ${settings.impostorsCount}+1))" class="w-8 h-8 glass rounded-lg">+</button>
                                ` : `<span class="font-black text-indigo-400">${settings.impostorsCount}</span>`}
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-xs font-bold uppercase text-gray-400">Indices</span>
                            <label class="switch">
                                <input type="checkbox" ${settings.hintsEnabled ? 'checked' : ''} ${!isHost ? 'disabled' : ''} onchange="window.updateSettings('hintsEnabled', this.checked)">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="space-y-2">
                        <div class="flex justify-between px-1">
                            <label class="text-[10px] font-black text-gray-500 uppercase tracking-widest">Joueurs (${data.players.length})</label>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            ${data.players.map(p => `
                                <div class="flex items-center justify-between bg-white/5 p-4 rounded-2xl border border-white/10">
                                    <div class="flex items-center gap-3">
                                        <span>${p.isHost ? 'üëë' : 'üë§'}</span>
                                        <span class="font-bold ${p.id === currentUserId ? 'text-indigo-400' : ''}">${p.name}</span>
                                    </div>
                                    ${isHost && p.id !== currentUserId ? `
                                        <button onclick="window.kickPlayer('${p.id}')" class="text-red-500 hover:text-red-400 font-bold px-2 text-xl">√ó</button>
                                    ` : '<div class="w-2 h-2 rounded-full bg-emerald-500"></div>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="pt-4 space-y-3">
                        ${isHost ? `
                            <button onclick="window.startGame()" class="w-full btn-gradient p-5 rounded-2xl font-black uppercase text-lg shadow-xl ${data.players.length < 3 ? 'opacity-50 grayscale cursor-not-allowed' : ''}">
                                ${data.players.length < 3 ? 'Besoin de 3 joueurs' : 'Lancer la partie'}
                            </button>
                        ` : `<div class="p-5 text-center glass rounded-2xl italic text-gray-500 text-sm">En attente de l'h√¥te...</div>`}
                        <button onclick="window.resetToMenu()" class="w-full py-3 text-xs font-black text-gray-600 uppercase tracking-widest">Quitter</button>
                    </div>
                </div>`;
        }

        function renderGame(data) {
            const me = data.players.find(p => p.id === currentUserId);
            const activePlayers = data.players.filter(p => !p.eliminated);
            const speaker = data.players[data.gameState.currentSpeakerIndex];
            const isMyTurn = speaker && speaker.id === currentUserId && data.gameState.phase === 'word_entry';
            
            clearInterval(timerInterval);
            const timeLeft = Math.max(0, Math.floor((data.gameState.timer - Date.now()) / 1000));
            
            let html = `
                <div class="space-y-4 animate-in fade-in">
                    <!-- CARTE DU JOUEUR -->
                    <div class="perspective-1000 w-full h-40 mb-6" onclick="this.querySelector('.card-inner').classList.toggle('is-flipped')">
                        <div class="card-inner relative w-full h-full shadow-2xl rounded-[2rem]">
                            <div class="backface-hidden absolute inset-0 glass rounded-[2rem] flex flex-col items-center justify-center border-2 border-dashed border-white/20">
                                <span class="text-[10px] font-black uppercase text-indigo-400 animate-pulse-soft">Toucher pour r√©v√©ler</span>
                            </div>
                            <div class="backface-hidden absolute inset-0 ${me.role === 'Imposteur' ? 'bg-red-600' : 'bg-indigo-600'} rounded-[2rem] flex flex-col items-center justify-center p-6 text-center" style="transform: rotateY(180deg)">
                                <h3 class="font-black text-xl uppercase mb-1">${me.role} ${me.eliminated ? '(ELIMIN√â)' : ''}</h3>
                                <div class="bg-black/20 p-3 rounded-xl w-full">
                                    <p class="text-lg font-bold uppercase tracking-widest">${me.word}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- PHASE DE MOT -->
                    ${data.gameState.phase === 'word_entry' ? `
                        <div class="text-center space-y-4">
                            <h2 class="text-xl font-black italic uppercase">Au tour de <span class="text-indigo-400">${speaker.name}</span></h2>
                            <div class="relative h-2 w-full bg-white/10 rounded-full overflow-hidden">
                                <div id="timer-bar" class="progress-bar absolute h-full bg-indigo-500" style="width: ${(timeLeft/15)*100}%"></div>
                            </div>
                            
                            ${isMyTurn ? `
                                <div class="glass p-6 rounded-3xl space-y-4 border-indigo-500/30 animate-pulse-red">
                                    <input type="text" id="word-input" maxlength="20" placeholder="Ton mot..." class="w-full bg-white/10 p-5 rounded-2xl text-center font-black text-2xl uppercase outline-none border border-white/20 focus:border-indigo-500 text-white">
                                    <button onclick="window.sendWord()" class="w-full btn-gradient p-5 rounded-2xl font-black uppercase text-lg">Envoyer le mot</button>
                                </div>
                            ` : `
                                <div class="glass p-8 rounded-[2rem] text-gray-500 italic flex items-center justify-center gap-3">
                                    <div class="w-2 h-2 bg-indigo-500 rounded-full animate-bounce"></div>
                                    R√©flexion en cours...
                                </div>
                            `}
                        </div>
                    ` : ''}

                    <!-- PHASE DE VOTE -->
                    ${data.gameState.phase === 'voting' ? `
                        <div class="text-center space-y-4">
                            <h2 class="text-3xl font-black text-red-500 uppercase italic">VOTE D'√âLIMINATION</h2>
                            <p class="text-xs text-gray-400 uppercase tracking-widest">Majorit√© requise pour √©liminer</p>
                            <div class="relative h-2 w-full bg-white/10 rounded-full overflow-hidden mb-4">
                                <div id="timer-bar" class="progress-bar absolute h-full bg-red-500" style="width: ${(timeLeft/15)*100}%"></div>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                ${activePlayers.map(p => {
                                    const voteCount = Object.values(data.gameState.votes || {}).filter(v => v === p.id).length;
                                    const hasVoted = data.gameState.votes && data.gameState.votes[currentUserId];
                                    return `
                                        <button onclick="${!me.eliminated ? `window.castVote('${p.id}')` : ''}" class="flex items-center justify-between p-4 glass rounded-2xl font-bold border ${hasVoted === p.id ? 'border-indigo-500 bg-indigo-500/10' : 'border-white/5'}">
                                            <span>${p.name}</span>
                                            <div class="flex items-center gap-2">
                                                <span class="text-xs text-gray-500">${voteCount} voix</span>
                                                ${hasVoted === p.id ? '‚úÖ' : ''}
                                            </div>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    ` : ''}

                    <!-- FLUX DES MOTS -->
                    <div class="space-y-3 mt-8">
                        <p class="text-[10px] font-black text-gray-500 uppercase tracking-widest border-b border-white/5 pb-2">Journal des indices</p>
                        <div class="flex flex-col gap-2 max-h-40 overflow-y-auto pr-2">
                            ${data.gameState.words.map(w => `
                                <div class="flex items-center gap-3 text-sm">
                                    <span class="font-black text-indigo-400 uppercase text-[10px] min-w-[60px]">${w.name}:</span>
                                    <span class="bg-white/5 px-4 py-2 rounded-xl border border-white/5 font-bold">${w.text}</span>
                                </div>
                            `).reverse().join('')}
                        </div>
                    </div>
                </div>`;

            document.getElementById('dynamic-content').innerHTML = html;

            // Timer Loop
            timerInterval = setInterval(async () => {
                const bar = document.getElementById('timer-bar');
                const now = Date.now();
                const diff = data.gameState.timer - now;
                if(bar) bar.style.width = Math.max(0, (diff / 16000) * 100) + "%";
                
                if(diff <= 0) {
                    clearInterval(timerInterval);
                    if(isHost) {
                        if(data.gameState.phase === 'word_entry') window.sendWord();
                        else if(data.gameState.phase === 'voting') window.resolveVote();
                    }
                }
            }, 1000);
        }

        function renderVictory(data) {
            const winner = data.winner;
            const impostors = data.players.filter(p => p.role === 'Imposteur').map(p => p.name).join(', ');
            
            document.getElementById('dynamic-content').innerHTML = `
                <div class="text-center space-y-8 py-10 animate-in zoom-in">
                    <h1 class="text-6xl font-black italic ${winner === 'Civils' ? 'text-indigo-500' : 'text-red-500'} tracking-tighter">VICTOIRE<br>${winner.toUpperCase()}</h1>
                    <div class="glass p-8 rounded-[2rem] space-y-4">
                        <p class="text-gray-400 uppercase text-[10px] tracking-widest font-bold">L'imposteur √©tait</p>
                        <p class="text-2xl font-black">${impostors}</p>
                    </div>
                    <button onclick="window.resetToMenu()" class="w-full btn-gradient p-5 rounded-2xl font-black uppercase text-lg">Retour au Salon</button>
                </div>
            `;
        }

        window.sendWord = async () => {
            const input = document.getElementById('word-input');
            const wordText = (input && input.value.trim()) ? input.value.trim() : "PASS√â";
            const roomRef = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(roomRef);
            const data = snap.data();
            
            const newWords = [...data.gameState.words, { name: data.players[data.gameState.currentSpeakerIndex].name, text: wordText }];
            
            // Trouver le prochain orateur non √©limin√©
            let nextIndex = data.gameState.currentSpeakerIndex;
            let foundNext = false;
            for(let i = 1; i <= data.players.length; i++) {
                let idx = (data.gameState.currentSpeakerIndex + i) % data.players.length;
                if(!data.players[idx].eliminated) {
                    nextIndex = idx;
                    foundNext = true;
                    break;
                }
            }

            // Si on a fait un tour complet (tous les joueurs actifs ont parl√©)
            const activeCount = data.players.filter(p => !p.eliminated).length;
            const turnWordsCount = newWords.length % activeCount;
            let nextPhase = (turnWordsCount === 0) ? 'voting' : 'word_entry';

            await updateDoc(roomRef, {
                "gameState.words": newWords,
                "gameState.currentSpeakerIndex": nextIndex,
                "gameState.phase": nextPhase,
                "gameState.timer": Date.now() + 16000,
                "gameState.votes": {}
            });
        };

        window.castVote = async (targetId) => {
            const roomRef = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(roomRef);
            const votes = snap.data().gameState.votes || {};
            votes[currentUserId] = targetId;
            await updateDoc(roomRef, { "gameState.votes": votes });
            
            // Si tout le monde a vot√©, on peut abr√©ger
            const activePlayers = snap.data().players.filter(p => !p.eliminated);
            if(Object.keys(votes).length >= activePlayers.length && isHost) {
                window.resolveVote();
            }
        };

        window.resolveVote = async () => {
            if(!isHost) return;
            const roomRef = doc(db, "rooms", currentRoomId);
            const snap = await getDoc(roomRef);
            const data = snap.data();
            const votes = data.gameState.votes || {};
            const activePlayers = data.players.filter(p => !p.eliminated);
            
            if(Object.keys(votes).length === 0) {
                // Pas de votes, on retourne aux mots
                await updateDoc(roomRef, { "gameState.phase": 'word_entry', "gameState.timer": Date.now() + 16000 });
                return;
            }

            // Compter les votes
            const counts = {};
            Object.values(votes).forEach(vid => counts[vid] = (counts[vid] || 0) + 1);
            
            let topId = null;
            let maxVotes = 0;
            for(const [id, count] of Object.entries(counts)) {
                if(count > maxVotes) { maxVotes = count; topId = id; }
                else if(count === maxVotes) { topId = null; } // √âgalit√©
            }

            // Logique de majorit√© (plus de la moiti√© des votants)
            const majority = Object.keys(votes).length / 2;

            if(topId && maxVotes > majority) {
                // √âlimination
                const updatedPlayers = data.players.map(p => {
                    if(p.id === topId) p.eliminated = true;
                    return p;
                });

                const eliminatedPlayer = updatedPlayers.find(p => p.id === topId);
                
                // Conditions de victoire
                const remainingImpos = updatedPlayers.filter(p => p.role === 'Imposteur' && !p.eliminated).length;
                const remainingCivils = updatedPlayers.filter(p => p.role === 'Civil' && !p.eliminated).length;

                if(remainingImpos === 0) {
                    await updateDoc(roomRef, { status: 'finished', winner: 'Civils', players: updatedPlayers });
                } else if(remainingCivils <= remainingImpos) {
                    await updateDoc(roomRef, { status: 'finished', winner: 'Imposteurs', players: updatedPlayers });
                } else {
                    // La partie continue, on cherche le prochain orateur
                    let nextSpeaker = 0;
                    for(let i=0; i<updatedPlayers.length; i++) {
                        if(!updatedPlayers[i].eliminated) { nextSpeaker = i; break; }
                    }
                    await updateDoc(roomRef, { 
                        players: updatedPlayers, 
                        "gameState.phase": 'word_entry', 
                        "gameState.currentSpeakerIndex": nextSpeaker,
                        "gameState.timer": Date.now() + 16000 
                    });
                }
            } else {
                // Pas de majorit√© ou √©galit√© : on retourne aux mots
                await updateDoc(roomRef, { "gameState.phase": 'word_entry', "gameState.timer": Date.now() + 16000 });
            }
        };

        window.resetToMenu = async () => {
            if(unsubscribeRoom) unsubscribeRoom();
            location.reload();
        };

    </script>
</body>
</html>
